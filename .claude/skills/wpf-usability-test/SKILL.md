---
name: wpf-usability-test
description: ペルソナ型ユーザビリティテスト（思考発話法 + ゴール指向）
argument-hint: --pid <PID> --goal "目的" [--persona <name_or_text>]
---

WPF アプリのユーザビリティテストを実行してください。
ペルソナ（架空のユーザー像）を設定し、ゴールだけを与えて「思考発話法」で操作することで、UI/UX の改善点を特定します。
Claude Code 自身がペルソナになりきり、`wpf-agent ui` コマンドで直接操作します。
外部 API キー (ANTHROPIC_API_KEY) は不要です。

指示: $ARGUMENTS

## 引数の解析

以下の引数を解析する:
- `--pid <PID>` or `--exe <path>`: 対象アプリ（必須）
- `--goal "目的"`: ユーザーの目的（必須）
- `--persona <name_or_text>`: プリセット名 or インラインテキスト（省略時は "tanaka"）

## ペルソナの解決

`--persona` の値を以下の順で解決する:

1. **プリセット名として検索**: `wpf-agent personas list` の名前と一致するか確認
   - 一致すれば、そのプリセットの description を使用
   ```bash
   wpf-agent personas list
   ```
2. **インラインテキスト**: プリセット名に一致しなければ、指定テキストをそのままペルソナ説明として使用
3. **省略時のデフォルト**: `--persona` 未指定時は プリセット "tanaka" を使用

## 準備

### 1. ターゲット特定

```bash
# 方法A: 未起動 → launch で起動し PID を取得
wpf-agent launch --exe <path>

# 方法B: 起動済み → ウィンドウ一覧から PID を探す
wpf-agent ui windows --brief

# 方法C: プロセス名から PID を取得
wpf-agent ui alive --process <name> --brief
```
`--pid` 指定時はこの手順をスキップ。

### 2. セッションディレクトリ作成

タイムスタンプ付きディレクトリを作成:
```
artifacts/sessions/usability_YYYYMMDD_HHMMSS/
```

Write ツールで以下のファイルを作成:

#### persona.md
```markdown
# ペルソナ定義

**名前**: （ペルソナ名）
**年齢**: （年齢）
**職業**: （職業）
**ITリテラシー**: （レベル）
**特徴**: （行動特性）
```

#### thinkaloud.md（初期ヘッダー）
```markdown
# 思考発話ログ

| ペルソナ | （ペルソナ名） |
|---------|---------------|
| ゴール | （目的） |
| 開始時刻 | （時刻） |

---
```

#### actions.md（初期ヘッダー）
```markdown
# 操作記録

| # | 時刻 | 操作 | 対象 | 結果 |
|---|------|------|------|------|
```

### 3. ウィンドウフォーカス

```bash
wpf-agent ui focus --pid <pid>
```

## メインループ（思考発話法）

**最大30ステップ**まで以下を繰り返す。ゴール達成または断念で終了。

各ステップで以下を実行:

### a. スクリーンショット撮影

```bash
wpf-agent ui screenshot --pid <pid> --save artifacts/sessions/usability_<timestamp>/step_NN.png
```

### b. スクリーンショットを確認

Read ツールで画像ファイルを読み込み、画面の状態を視覚的に把握する。

### c. コントロール一覧取得

```bash
wpf-agent ui controls --pid <pid> --depth 4 --has-aid --brief
```

### d. ペルソナとして思考を声に出す

**ここが最重要ステップ。** ペルソナになりきって、以下を**ユーザーに表示**する:

> **[ペルソナ名] Step N:**
> 「（画面を見た第一印象）」
> 「（何をしようとしているか）」
> 「（どのボタン/要素を選ぶか、その理由）」
> 「（迷いや不安があれば正直に）」

思考の例:
- 「この画面は...えっと、ボタンが3つあるけど、どれが設定かな？」
- 「"MainButton" って書いてあるけど、何が起きるかわからなくて少し不安...」
- 「入力欄があるけど、何を入れればいいのかヒントがない...」
- 「あ、カウンターが増えた！これを5回繰り返せばいいのかな」

同時に、Write ツールで `thinkaloud.md` に追記:
```markdown
### Step N (M:SS)
**画面**: （画面の状態を簡潔に描写）
**思考**: 「（思考発話の内容）」
**行動**: （何をするか）
**操作**: `wpf-agent ui <command> --pid <pid> ...`
![step_NN](step_NN.png)
```

### e. 操作を実行

```bash
# クリック
wpf-agent ui click --pid <pid> --aid <automation_id>

# テキスト入力
wpf-agent ui type --pid <pid> --aid <automation_id> --text "テスト値"

# トグル
wpf-agent ui toggle --pid <pid> --aid <automation_id>

# テキスト読み取り
wpf-agent ui read --pid <pid> --aid <automation_id>

# 状態確認
wpf-agent ui state --pid <pid> --aid <automation_id>
```

### f. 結果を確認し反応を記録

再度スクリーンショットを撮影し、ペルソナとして反応を表示:

> **[ペルソナ名] 反応:**
> 「（操作後の反応）」

反応の例:
- 「あ、変わった！でも思ってたのと違う...」
- 「エラーが出た...どうしよう、元に戻せるのかな？」
- 「よし、カウンターが1つ増えた！あと4回だ」
- 「何も起きない...壊れてる？もう一回押してみよう」

Write ツールで `actions.md` に行を追記:
```markdown
| N | M:SS | click | MainButton | StatusLabel が "Clicked" に変化 |
```

### g. ユーザビリティ問題を記録

操作中に以下を感じたら**問題として記録**する（最終報告書用にメモ）:
- **迷い**: どこを押せばいいかわからない
- **誤解**: ボタンの意味を間違えた
- **不安**: 何が起きるかわからず躊躇した
- **フラストレーション**: 期待通りに動かない
- **効率の悪さ**: 必要以上にステップが多い
- **発見不能**: 必要な機能が見つからない

### h. 終了判定

- **ゴール達成**: 目的を達成できた → ループ終了
- **断念**: ペルソナが「もうわからない、諦める」と判断 → ループ終了
- **上限到達**: 30ステップに到達 → ループ終了

## 最終報告書の作成

ループ終了後、Write ツールで `usability_report.md` を作成:

```markdown
# ユーザビリティテスト報告書

## テスト概要

| 項目 | 内容 |
|------|------|
| 対象アプリ | （アプリ名 / PID） |
| ペルソナ | （ペルソナ名・属性） |
| ゴール | （目的） |
| 結果 | 達成 / 未達成（断念）/ 未達成（上限到達） |
| 所要ステップ | N ステップ |
| 所要時間（推定） | （ステップ数から推定） |

## タスク達成結果

（ゴール達成の詳細。達成できた場合はどのようなパスで達成したか。
 未達成の場合は何が障害になったか。）

## 発見されたユーザビリティ問題

### 問題 1: （問題タイトル）
- **重大度**: 高 / 中 / 低
- **カテゴリ**: ナビゲーション / ラベリング / フィードバック / レイアウト / エラー処理
- **発生ステップ**: Step N
- **状況**: （何が起きたか）
- **ペルソナの反応**: 「（思考発話からの引用）」
- **改善提案**: （具体的な改善案）

### 問題 2: ...

（全問題を列挙）

## 思考発話ハイライト

| Step | 発言 | 示唆される問題 |
|------|------|--------------|
| N | 「...」 | （問題の要約） |

## ナビゲーションパス

```
画面A → (操作) → 画面B → (操作) → 画面C → ...
```

## 改善提案（優先度順）

1. **[高]** （提案内容）
2. **[中]** （提案内容）
3. **[低]** （提案内容）

## エビデンス一覧

| ファイル | 内容 |
|---------|------|
| persona.md | ペルソナ定義 |
| thinkaloud.md | 思考発話ログ（全発言） |
| actions.md | 操作記録（全コマンド・結果） |
| step_01.png - step_NN.png | 各ステップのスクリーンショット |
```

## チケット作成

報告書作成後、以下の CLI コマンドでチケットを作成する。

#### a. テスト結果を整理して以下を決定
- **title**: 問題ありなら `ユーザビリティ: <主要な問題>` / 問題なしなら `ユーザビリティテスト完了 — 問題なし (<アプリ名>)`
- **summary**: ペルソナ名、ゴール、達成/未達成、発見した問題数を含む
- **actual**: テストで実際に起きたこと
- **expected**: 期待されるユーザー体験
- **repro**: テストで実行した操作手順 (wpf-agent ui コマンドで記述)
- **evidence**: スクリーンショットのパス

#### b. CLI でチケットを作成
```bash
wpf-agent tickets create --title "タイトル" --summary "概要" --actual-result "実際の結果" --expected-result "期待される結果" --repro-steps "ステップ1" --repro-steps "ステップ2" --evidence "artifacts/sessions/usability_.../step_01.png" --root-cause "原因の仮説" --pid <pid>
```
**注意**: 全引数を1行で記述すること。`--repro` と `--evidence` は複数回指定可能。

## アプリ終了（launch で起動した場合）

```bash
wpf-agent ui close --pid <pid>
```
`wpf-agent launch` で起動したプロセスのみ閉じられる (WM_CLOSE)。手動で起動したアプリはユーザーに閉じてもらう。

## ユーザーへの報告

チケット作成後、以下を表示する:
- 報告書のパス (`usability_report.md`)
- 思考発話ログのパス (`thinkaloud.md`)
- 操作記録のパス (`actions.md`)
- チケットのパス
- 主要な発見事項（問題数・重大度の概要）
- タスク達成結果

## セレクタの優先順位
1. `--aid` (automation_id) — 最も安定
2. `--name` + `--control-type` — aid がない場合
3. スクリーンショットの座標情報から判断 — 最後の手段

## ユーザー中断の対応 (UI ガード)

UI 操作コマンド (`focus`, `click`, `type`, `toggle`) は実行前にマウス移動を検知する。
ユーザーがマウスを動かすと操作は中断され、exit code 2 + JSON が返る:
```json
{"interrupted": true, "reason": "mouse_movement", "detail": "...", "command": "click", "action": "Run 'wpf-agent ui resume' to continue."}
```

**中断を検知したら:**
1. メインループを即座に停止する
2. **それまでの結果で報告書を作成する**（最終報告書の作成へ進む）
3. チケットを作成する（チケット作成セクションへ進む）
4. ユーザーに報告する

読み取り専用コマンド (`screenshot`, `controls`, `read`, `state`) は一時停止中も実行可能。

## 注意事項
- 各ステップでスクリーンショットを保存し、変化を追跡すること
- プロセスの生存確認は `wpf-agent ui alive --pid <pid>` を使う
- アプリがクラッシュした場合は報告書に記録して終了
- 破壊的操作（削除ボタン等）はペルソナの性格に応じて判断すること
- **Bash コマンドは必ず1行で記述する** — パーミッション glob `*` は改行にマッチしないため
- ペルソナの思考は**自然な日本語の口語**で表現すること（「〜だな」「〜かな？」「あれ？」等）
